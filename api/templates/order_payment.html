<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Оплата заказа</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>Оплата заказа</h1>
    <p>Сумма: {{ amount }} {{ currency|upper }}</p>

    <form id="payment-form">
        <div id="card-element"></div>
        <button id="submit">Оплатить</button>
        <div id="payment-result"></div>
    </form>

    <script>
        const stripe = Stripe("{{ stripe_public_key }}");
        const elements = stripe.elements();
        const card = elements.create("card");
        card.mount("#card-element");

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const form = document.getElementById("payment-form");
        form.addEventListener("submit", async (event) => {
            event.preventDefault();

            const response = await fetch("{% url 'create-order-payment-intent' order.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({})
            });

            const data = await response.json();

            if (data.error) {
                document.getElementById("payment-result").innerText = data.error;
                return;
            }

            const clientSecret = data.clientSecret;

            const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: card
                }
            });

            if (error) {
                document.getElementById("payment-result").innerText = error.message;
            } else if (paymentIntent.status === "succeeded") {
                document.getElementById("payment-result").innerText = "Оплата прошла успшено!";
                window.location.href = "/success";
            }
        });
    </script>
</body>
</html>